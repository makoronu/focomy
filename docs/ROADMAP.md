# ROADMAP

## 参照

- [設計書](../focomy_specification.md)

---

## 進行中

| ID | タスク | 開始日 | 状態 |
|----|--------|--------|------|
| 108 | 投稿本文インポート修正 | 2026-01-02 | S1準備中 |

---

## 093: HTML→ブロック変換器 詳細

### 概要

WordPress HTML/Gutenberg → Editor.jsブロック形式への変換

### セグメント構成

```
[S1: 基盤+paragraph] → [S2: 基本ブロック] → [S3: 特殊ケース]
                                                    ↓
                       [S5: インポーター統合] ← [S4: クラシックHTML]
```

### S1: 基盤 + paragraph（最小動作確認） - 完了

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 1 | `block_converter.py`作成 | `services/block_converter.py` | 完了 |
| 2 | Gutenbergコメント検出 | 同上 | 完了 |
| 3 | paragraph変換 | 同上 | 完了 |

**テスト結果**: 基本/属性付き/インラインHTML/複数ブロック/空/未知ブロック 全てOK

### S2: 基本ブロック追加 - 完了

| # | タスク | 状態 |
|---|--------|------|
| 4 | header変換 | 完了 |
| 5 | list変換 | 完了 |
| 6 | image変換 | 完了 |
| 7 | quote変換 | 完了 |
| 8 | code変換 | 完了 |
| 9 | delimiter変換 | 完了 |
| 10 | table変換 | 完了 |

**テスト結果**: 全7ブロック変換OK

### S3: 特殊ケース対応 - 完了

| # | タスク | 状態 |
|---|--------|------|
| 11 | embed変換（YouTube等） | 完了 |
| 12 | freeform（クラシック）変換 | 完了 |
| 13 | 未知ブロック→raw変換 | 完了 |
| 14 | ネストブロック→フラット化 | 完了 |

**テスト結果**: embed/html/未知ブロック/columnsフラット化 全てOK

### S4: クラシックHTML対応 - 完了

| # | タスク | 状態 |
|---|--------|------|
| 15 | Gutenbergなし検出 | 完了 |
| 16 | BeautifulSoupでHTMLパース | 完了 |
| 17 | HTML→ブロック変換 | 完了 |

**テスト結果**: p/h2/ul/img/blockquote/pre/table 全て変換OK

### S5: インポーターへ統合 - 完了

| # | タスク | 状態 |
|---|--------|------|
| 18 | importer.pyで変換器呼び出し | 完了 |
| 19 | content→body(blocks)に変換 | 完了 |

**テスト結果**: シンタックスOK、統合完了
**人作業**: 実WXRでインポート確認

### エラー対策

| リスク | 対策 |
|--------|------|
| パース失敗 | 元HTMLをrawブロックで保持 |
| 不正JSON属性 | try-except + デフォルト値 |
| ネスト深すぎ | 深さ制限（max 10） |
| 巨大HTML | サイズ制限（5MB） |
| 未知ブロック | rawブロックで保持 |

---

## 108: 投稿本文インポート修正 詳細

### 概要

WordPress投稿をFocomyにインポートする際のデータ変換・リレーション設定を修正

### 発見した問題

| # | 問題 | 深刻度 |
|---|------|--------|
| 1 | post_categories リレーション未定義 | 致命的 |
| 2 | post.yaml に wp_id なし | 高 |
| 3 | page.yaml に wp_id なし | 高 |
| 4 | user.yaml に wp_id なし | 高 |
| 5 | SEOネストオブジェクト未対応 | 中 |
| 6 | チャンネル割り当てロジックなし | 中 |
| 7 | featured_image ID解決なし | 中 |

### セグメント構成

```
[S1: Content Types + Relations修正]
    ↓ マイグレーション実行で確認
[S2: ID解決ユーティリティ]
    ↓ 単体テストで確認
[S3: _transform_post修正]
    ↓ モックデータで確認
[S4: リレーション設定]
    ↓ E2Eテストで確認
```

### S1: Content Types + Relations修正 - 完了

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 1 | post.yaml に wp_id 追加 | `content_types/post.yaml` | 完了 |
| 2 | page.yaml に wp_id 追加 | `content_types/page.yaml` | 完了 |
| 3 | user.yaml に wp_id 追加 | `content_types/user.yaml` | 完了 |
| 4 | post_categories リレーション追加 | `relations.yaml` | 完了 |
| 5 | post.yaml に post_categories 追加 | `content_types/post.yaml` | 完了 |

**テスト結果**: YAML構文チェック OK

### S2: ID解決ユーティリティ

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 1 | WpIdResolver クラス作成 | `services/wordpress_import/id_resolver.py` | 未着手 |
| 2 | wp_id → entity_id 変換 | 同上 | 未着手 |
| 3 | slug → entity_id 変換 | 同上 | 未着手 |
| 4 | メディアURL解決 | 同上 | 未着手 |

**インターフェース**:
```python
class WpIdResolver:
    async def resolve_user(self, wp_id: int) -> str | None
    async def resolve_category(self, slug: str) -> str | None
    async def resolve_tag(self, slug: str) -> str | None
    async def resolve_media(self, wp_id: int) -> str | None
    async def get_default_channel(self) -> str
```

**確認方法**: print文で解決結果確認

### S3: _transform_post修正

| # | タスク | 状態 |
|---|--------|------|
| 1 | SEOネスト→フラット変換 | 未着手 |
| 2 | 不要フィールド除去（meta等） | 未着手 |
| 3 | wp_id フィールド追加 | 未着手 |
| 4 | featured_image URL解決 | 未着手 |

**変換前**:
```python
{
    "wp_id": 123,
    "seo": {"title": "...", "description": "..."},
    "author_wp_id": 1,
    "categories": ["slug1", "slug2"],
    "tags": ["tag1"],
    "featured_image": 456,  # WP media ID
    "meta": {...},
}
```

**変換後**:
```python
{
    "wp_id": 123,
    "seo_title": "...",
    "seo_description": "...",
    # author_wp_id, categories, tags, meta 削除
    # featured_image → URL or Focomy media ID
}
```

**確認方法**: サンプルデータで変換結果確認

### S4: リレーション設定

| # | タスク | 状態 |
|---|--------|------|
| 1 | post_author 設定 | 未着手 |
| 2 | post_channel 設定 | 未着手 |
| 3 | post_categories 設定 | 未着手 |
| 4 | post_tags 設定 | 未着手 |
| 5 | page_author 設定 | 未着手 |
| 6 | page_parent 設定 | 未着手 |

**確認方法**: 実インポート → 管理画面で確認

### 依存関係

```
S1 (YAML修正)
 ↓
S2 (ID解決) ← S1完了必須
 ↓
S3 (データ変換) ← S2完了必須
 ↓
S4 (リレーション) ← S2, S3完了必須
```

---

## 105: プレビュー機能強化 詳細

### 概要

エディタ内リアルタイムプレビュー + レスポンシブ切替 + OGP/SEOプレビュー

### セグメント構成

```
[S1: API] ─────────────────┐
                           ↓
[S2: 静的UI] ──→ [S3: コア接続] ──→ [S4: レイアウト切替]
                           │                ↓
                           │        [S5: レスポンシブ]
                           │
                           └──→ [S6: OGP/SEO]（独立）
```

### S1: APIのみ（バックエンド完結） - 完了

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| A2 | `render_blocks_html()`公開化 | `services/theme.py` | 完了 |
| A1 | `POST /api/admin/preview/render` | `admin/routes.py` | 完了 |
| - | `require_admin_api()`追加 | `admin/routes.py` | 完了 |
| - | CSRF除外追加 | `main.py` | 完了 |

**テスト**: `curl -X POST -d '{"blocks":[...]}' /api/admin/preview/render` → 401（未認証）確認済

### S2: 静的UI骨格（JS動作なし） - 完了

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| D1 | 分割レイアウトCSS | `entity_form.html` | 完了 |
| B1 | 分割レイアウトHTML構造 | `entity_form.html` | 完了 |
| B2 | レイアウト切替ボタンUI | `entity_form.html` | 完了 |
| B4 | レスポンシブ切替ボタンUI | `entity_form.html` | 完了 |

**テスト**: ブラウザで見た目確認済

### S3: コア機能接続（最重要） - 完了

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| C2 | デバウンス関数 | `editor.html` | 完了 |
| C1 | プレビュー更新関数 | `editor.html` | 完了 |
| C7 | エラーハンドリング | `editor.html` | 完了 |
| C6 | JSONモード時無効化 | `editor.html` | 完了 |
| - | レイアウト切替関数 | `editor.html` | 完了 |
| - | デバイス切替関数 | `editor.html` | 完了 |
| - | localStorage状態保持 | `editor.html` | 完了 |

**テスト**: 文字入力 → 300ms後 → プレビュー反映

### S4: レイアウト切替 - 完了（S3に統合）

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| C3 | レイアウト切替関数 | `editor.html` | 完了 |
| - | 状態保持（localStorage） | `editor.html` | 完了 |

**テスト**: 3モード切替動作、リロード後も維持

### S5: レスポンシブプレビュー - 完了（S3に統合）

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| C4 | レスポンシブ切替関数 | `editor.html` | 完了 |
| D2 | デバイスフレームCSS | `entity_form.html` | 完了 |

**テスト**: Desktop/Tablet/Mobile切替でiframe幅変更

### S6: OGP/SEO - スキップ

**理由**: `SEOService`で既に自動生成が動作中。プレビューUI不要。

- og:title ← titleフィールドから自動
- og:description ← excerpt or 本文冒頭160字から自動
- og:image ← featured_imageから自動

**結論**: 9割のユーザーが使わない機能は作らない。

---

## 予定

### Phase 4: 変換器

| ID | タスク | 優先度 | 依存 | Issue |
|----|--------|--------|------|-------|
| 093 | HTML→ブロック変換器 | 高 | 102 | #61 |
| 107 | Gutenbergブロック解析 | 高 | 093 | #61 |
| 115 | ショートコード変換 | 中 | 093 | #71 |
| 116 | Embed変換 | 中 | 093 | #76 |

### Phase 5: インポート基本修正

| ID | タスク | 優先度 | 依存 | Issue |
|----|--------|--------|------|-------|
| 108 | 投稿本文インポート修正 | 高 | 107 | #57 |
| 109 | 画像インポート完全再現 | 高 | 108 | #58,#63 |
| 110 | カテゴリ・タグ修正 | 高 | 108 | #59 |
| 111 | インポート後URL修正 | 高 | 108 | #53 |
| 112 | 著者・チャンネル修正 | 高 | 108 | #60 |
| 117 | ユーザー/著者作成 | 中 | 108 | #70 |
| 118 | 内部リンク自動書換 | 中 | 108 | #75 |

### Phase 6: テーマ・表示

| ID | タスク | 優先度 | 依存 | Issue |
|----|--------|--------|------|-------|
| 094 | テーマCSS抽出・適用 | 高 | 112 | #62 |
| 113 | デフォルトCSS追加 | 高 | 094 | #54 |
| 114 | 抜粋HTMLタグ除去 | 中 | - | #55 |

### Phase 7: インポート拡張

| ID | タスク | 優先度 | 依存 | Issue |
|----|--------|--------|------|-------|
| 119 | メニューインポート | 中 | 112 | #65 |
| 120 | 301リダイレクト生成 | 中 | 112 | #66 |
| 121 | SEOデータインポート | 中 | 112 | #67 |
| 122 | ACFフィールド対応 | 低 | 112 | #69 |
| 123 | カスタム投稿タイプ変換 | 低 | 112 | #73 |

### Phase 8: 将来

| ID | タスク | 優先度 | 依存 | Issue |
|----|--------|--------|------|-------|
| 124 | インポート進捗表示 | 低 | 112 | #86 |
| 125 | 多言語サイト対応 | 低 | 112 | #92 |
| 126 | ユーザー管理UI本格対応 | 中 | - | - |

---

## 完了（直近）

| ID | タスク | 完了日 |
|----|--------|--------|
| 115 | ショートコード変換 | 2026-01-02 |
| 093 | HTML→ブロック変換器（S1-S5完了） | 2026-01-02 |
| 105 | プレビュー機能強化（S1-S5完了、S6スキップ） | 2026-01-02 |
| 103 | コードエディタ切替実装 | 2026-01-02 |
| 104 | Ctrl+S保存実装 | 2026-01-02 |
| 102 | インラインツール拡充 | 2026-01-02 |
| 100 | ブロック配置機能追加 | 2026-01-02 |
| 101 | テキスト色・背景色追加 | 2026-01-02 |
| 095 | 見出しh1-h6対応 | 2026-01-02 |
| 096 | ギャラリーブロック追加 | 2026-01-02 |
| 097 | カバーブロック追加 | 2026-01-02 |
| 098 | グループブロック追加 | 2026-01-02 |
| 099 | スペーサーブロック追加 | 2026-01-02 |
| 092 | UI/UXシンプル化 | 2026-01-02 |
| 091 | 機能安定化（Phase 1-7） | 2026-01-01 |

---

## 完了

| ID | タスク | 完了日 |
|----|--------|--------|
| 036 | トランザクション境界修正 | 2025-12-28 |
| 037 | many_to_one制約実装 | 2025-12-28 |
| 038 | unique制約実装 | 2025-12-28 |
| 039 | 初期管理者作成CLI | 2025-12-28 |
| 040 | パスワードリセット機能 | 2025-12-28 |
| 041 | DBバックアップCLI改善 | 2025-12-28 |
| 042 | Editor.js XSSサニタイズ | 2025-12-28 |
| 043 | 循環参照検出 | 2025-12-28 |
| 044 | 楽観的ロック実装 | 2025-12-28 |
| 045 | indexed: true インデックス作成 | 2025-12-28 |
| 046 | 検索エンジン実装 | 2025-12-28 |
| 047 | ロギング基盤 | 2025-12-28 |
| 048 | DBマイグレーション戦略 | 2025-12-28 |
| 049 | 論理削除の波及 | 2025-12-28 |
| 050 | メディア削除時の参照整合性 | 2025-12-28 |
| 051 | ワークフロー状態遷移の強制 | 2025-12-28 |
| 052 | 管理者操作の監査ログ | 2025-12-28 |
| 053 | RBAC権限マトリクス | 2025-12-28 |
| 054 | キャッシュRedis対応 | 2025-12-28 |
| 055 | TOTPバックアップコード | 2025-12-28 |
| 056 | プレビュー機能 | 2025-12-28 |
| 057 | ゴミ箱UI | 2025-12-28 |
| 058 | S3ストレージ実装 | 2025-12-28 |
| 059 | メディアサムネイル生成 | 2025-12-28 |
| 060 | セッション管理強化 | 2025-12-28 |
| 061 | Formulaフィールド計算タイミング | 2025-12-28 |
| 062 | 孤立データクリーンアップ | 2025-12-28 |
| 063 | ページネーション標準化 | 2025-12-28 |
| 064 | バルク操作 | 2025-12-28 |
| 065 | CORS詳細設定 | 2025-12-28 |
| 066 | API全体のレート制限 | 2025-12-28 |
| 067 | 大量データ時の管理画面最適化 | 2025-12-28 |
| 068 | ユーザー招待フロー | 2025-12-28 |
| 069 | API認証（JWT/APIキー） | 2025-12-28 |
| 072 | Sentry統合 | 2025-12-28 |
| 032 | Content Builder（ACF的機能） | 2025-12-28 |
| 033 | WordPress インポート | 2025-12-28 |
| 034 | プラグインシステム | 2025-12-28 |
| 035 | テーママーケットプレイス | 2025-12-28 |
| 027 | メニュー管理システム | 2025-12-28 |
| 028 | 柔軟なブログルーティング | 2025-12-28 |
| 029 | 設定管理UI | 2025-12-28 |
| 030 | ウィジェット/サイドバー | 2025-12-28 |
| 031 | コメント機能 | 2025-12-28 |
| 001 | プロジェクト基盤構築 | 2025-12-26 |
| 002 | EntityService実装 | 2025-12-26 |
| 003 | RelationService実装 | 2025-12-26 |
| 004 | FieldService実装 | 2025-12-26 |
| 005 | 認証基盤構築 | 2025-12-26 |
| 006 | API実装 | 2025-12-26 |
| 007 | 管理画面基盤 | 2025-12-26 |
| 008 | Editor.js統合 | 2025-12-26 |
| 009 | メディア管理 | 2025-12-26 |
| 010 | SEO自動生成 | 2025-12-26 |
| 011 | テーマシステム | 2025-12-26 |
| 012 | CLI実装 | 2025-12-26 |
| 013 | robots.txt実装 | 2025-12-27 |
| 014 | フィード実装 | 2025-12-27 |
| 015 | ファビコン対応 | 2025-12-27 |
| 016 | SEO設定UI構築 | 2025-12-27 |
| 017 | 構造化データ拡充 | 2025-12-27 |
| 018 | ページ別SEO制御 | 2025-12-27 |
| 019 | パンくず実装 | 2025-12-27 |
| 020 | OGP/Twitter補完 | 2025-12-27 |
| 021 | 外部CSS分離 | 2025-12-27 |
| 022 | パフォーマンス最適化 | 2025-12-27 |
| 023 | リダイレクト管理 | 2025-12-27 |
| 024 | セキュリティヘッダー | 2025-12-27 |
| 025 | リンク検証機能 | 2025-12-27 |
| 026 | サイトマップUI | 2025-12-27 |
| 070 | 多言語対応（i18n） | 2025-12-28 |
| 071 | テスト戦略 | 2025-12-28 |
| 073 | メディア整理 | 2025-12-28 |
| 074 | エクスポート機能 | 2025-12-28 |
| 075 | OAuth連携解除・ユーザーマージ | 2025-12-28 |
| 076 | path_prefix衝突検出 | 2025-12-28 |
| 077 | カスタムルーティング | 2025-12-28 |
| 078 | プラグイン依存関係解決 | 2025-12-28 |
| 079 | プラグイン権限分離 | 2025-12-28 |
| 080 | テーマ継承・子テーマ | 2025-12-28 |
| 081 | マーケットプレイス署名検証 | 2025-12-28 |
| 082 | 設定優先順位明確化 | 2025-12-28 |
| 083 | ゼロダウンタイムデプロイ | 2025-12-28 |
| 084 | コメントスパム高度対策 | 2025-12-28 |
| 085 | 用語統一 | 2025-12-28 |
| 086 | site_setting位置づけ明確化 | 2025-12-28 |
| 087 | created_by/updated_by FK制約 | 2025-12-28 |
| 088 | 設計書更新 | 2025-12-28 |
| 089 | pip installable対応 | 2025-12-28 |
| 090 | テンプレートパス解決修正 | 2025-12-29 |
