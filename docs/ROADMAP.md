# ROADMAP

## 参照

- [設計書](../focomy_specification.md)

---

## 進行中

(なし)

---

## 予定

(すべて完了)

---

## 詳細

### 089 pip installable 対応

#### 概要
`pip install focomy` → `focomy init mysite` → `focomy serve` で動くようにする

#### 対応
- pyproject.toml 依存関係追加（structlog, alembic, pyotp, python-jose, aiohttp, email-validator）
- Redis をオプショナル依存に（`pip install focomy[redis]`）
- パッケージデータのバンドル（themes/, content_types/, templates/）
- CLI 修正（importlib.resources でリソース参照）
- scaffold/ ディレクトリ作成（init用テンプレート）
- MANIFEST.in 作成

---

## 詳細

### 036 トランザクション境界修正

#### 概要
EntityService.create() で flush→値設定→commit が分離しており、途中失敗でゴーストレコードが発生する

#### 対応
- 単一トランザクションで Entity + EntityValue を作成
- エラー時は全体ロールバック

### 037 many_to_one制約実装

#### 概要
RelationService.attach() で many_to_one 時に同一 from_entity_id への重複登録を防止

#### 対応
- リレーション定義の type を確認
- many_to_one の場合は既存リレーションを削除してから作成

### 038 unique制約実装

#### 概要
slug 等の unique: true フィールドで重複を防止

#### 対応
- EntityService.create/update 時にDB検索
- 同一type内でのユニーク検証

### 039 初期管理者作成CLI

#### 概要
インストール直後に管理者ユーザーを作成するCLIコマンド

#### コマンド
```bash
focomy createuser --email admin@example.com --role admin
```

### 040 パスワードリセット機能

#### 概要
パスワードを忘れた場合のリセットフロー

#### フロー
1. /forgot-password でメールアドレス入力
2. リセットトークン生成・メール送信
3. /reset-password?token=xxx で新パスワード設定

### 041 DBバックアップCLI改善

#### 概要
pg_dump/pg_restore を連携したDBバックアップ

#### コマンド
```bash
focomy backup --include-db  # DB + uploads
focomy restore backup.zip
```

### 042 Editor.js XSSサニタイズ

#### 概要
blocks フィールドの rawHTML ブロック等でのXSS防止

#### 対応
- 出力時に許可タグ/属性のホワイトリスト適用
- bleach または DOMPurify 相当の処理

### 043 循環参照検出

#### 概要
self_referential: true のリレーションで A→B→C→A の循環を防止

#### 対応
- attach 時に祖先チェック
- 深さ制限（デフォルト10）

### 044 楽観的ロック実装

#### 概要
同時編集時のデータ競合を検出

#### 対応
- Entity.version カラム追加
- 更新時にversion比較、不一致でエラー

### 045 indexed: true インデックス作成

#### 概要
YAML定義の indexed: true からDBインデックスを生成

#### 対応
- entity_values に (entity_id, field_name, value_text) の部分インデックス
- migrate 時に自動作成

### 046 検索エンジン実装

#### 概要
日本語対応の全文検索

#### 選択肢
- PostgreSQL tsvector + pg_trgm
- Meilisearch 外部サービス

### 047 ロギング基盤

#### 概要
構造化ログ出力

#### 対応
- structlog 導入
- JSON形式ログ
- リクエストID追跡

### 048 DBマイグレーション戦略

#### 概要
バージョンアップ時のスキーマ変更管理

#### 対応
- Alembic 導入
- focomy migrate でマイグレーション実行

### 049 論理削除の波及

#### 概要
削除されたEntityを参照するRelationの処理

#### 対応
- 削除時にRelationを自動削除、または
- 取得時に削除Entity参照を除外

### 050 メディア削除時の参照整合性

#### 概要
メディア削除時に参照しているEntityの値を処理

#### 対応
- 参照チェック→警告表示
- 強制削除時はnull化

### 051 ワークフロー状態遷移の強制

#### 概要
ワークフロー定義に従った状態遷移のみ許可

#### 対応
- status 変更時に transitions をチェック
- 許可されていない遷移はエラー

### 052 管理者操作の監査ログ

#### 概要
誰が・いつ・何を変更したかの記録

#### 対応
- audit_logs テーブル追加
- Entity 変更時に before/after 記録

---

## 完了

| ID | タスク | 完了日 |
|----|--------|--------|
| 036 | トランザクション境界修正 | 2025-12-28 |
| 037 | many_to_one制約実装 | 2025-12-28 |
| 038 | unique制約実装 | 2025-12-28 |
| 039 | 初期管理者作成CLI | 2025-12-28 |
| 040 | パスワードリセット機能 | 2025-12-28 |
| 041 | DBバックアップCLI改善 | 2025-12-28 |
| 042 | Editor.js XSSサニタイズ | 2025-12-28 |
| 043 | 循環参照検出 | 2025-12-28 |
| 044 | 楽観的ロック実装 | 2025-12-28 |
| 045 | indexed: true インデックス作成 | 2025-12-28 |
| 046 | 検索エンジン実装 | 2025-12-28 |
| 047 | ロギング基盤 | 2025-12-28 |
| 048 | DBマイグレーション戦略 | 2025-12-28 |
| 049 | 論理削除の波及 | 2025-12-28 |
| 050 | メディア削除時の参照整合性 | 2025-12-28 |
| 051 | ワークフロー状態遷移の強制 | 2025-12-28 |
| 052 | 管理者操作の監査ログ | 2025-12-28 |
| 053 | RBAC権限マトリクス | 2025-12-28 |
| 054 | キャッシュRedis対応 | 2025-12-28 |
| 055 | TOTPバックアップコード | 2025-12-28 |
| 056 | プレビュー機能 | 2025-12-28 |
| 057 | ゴミ箱UI | 2025-12-28 |
| 058 | S3ストレージ実装 | 2025-12-28 |
| 059 | メディアサムネイル生成 | 2025-12-28 |
| 060 | セッション管理強化 | 2025-12-28 |
| 061 | Formulaフィールド計算タイミング | 2025-12-28 |
| 062 | 孤立データクリーンアップ | 2025-12-28 |
| 063 | ページネーション標準化 | 2025-12-28 |
| 064 | バルク操作 | 2025-12-28 |
| 065 | CORS詳細設定 | 2025-12-28 |
| 066 | API全体のレート制限 | 2025-12-28 |
| 067 | 大量データ時の管理画面最適化 | 2025-12-28 |
| 068 | ユーザー招待フロー | 2025-12-28 |
| 069 | API認証（JWT/APIキー） | 2025-12-28 |
| 072 | Sentry統合 | 2025-12-28 |
| 032 | Content Builder（ACF的機能） | 2025-12-28 |
| 033 | WordPress インポート | 2025-12-28 |
| 034 | プラグインシステム | 2025-12-28 |
| 035 | テーママーケットプレイス | 2025-12-28 |
| 027 | メニュー管理システム | 2025-12-28 |
| 028 | 柔軟なブログルーティング | 2025-12-28 |
| 029 | 設定管理UI | 2025-12-28 |
| 030 | ウィジェット/サイドバー | 2025-12-28 |
| 031 | コメント機能 | 2025-12-28 |
| 001 | プロジェクト基盤構築 | 2025-12-26 |
| 002 | EntityService実装 | 2025-12-26 |
| 003 | RelationService実装 | 2025-12-26 |
| 004 | FieldService実装 | 2025-12-26 |
| 005 | 認証基盤構築 | 2025-12-26 |
| 006 | API実装 | 2025-12-26 |
| 007 | 管理画面基盤 | 2025-12-26 |
| 008 | Editor.js統合 | 2025-12-26 |
| 009 | メディア管理 | 2025-12-26 |
| 010 | SEO自動生成 | 2025-12-26 |
| 011 | テーマシステム | 2025-12-26 |
| 012 | CLI実装 | 2025-12-26 |
| 013 | robots.txt実装 | 2025-12-27 |
| 014 | フィード実装 | 2025-12-27 |
| 015 | ファビコン対応 | 2025-12-27 |
| 016 | SEO設定UI構築 | 2025-12-27 |
| 017 | 構造化データ拡充 | 2025-12-27 |
| 018 | ページ別SEO制御 | 2025-12-27 |
| 019 | パンくず実装 | 2025-12-27 |
| 020 | OGP/Twitter補完 | 2025-12-27 |
| 021 | 外部CSS分離 | 2025-12-27 |
| 022 | パフォーマンス最適化 | 2025-12-27 |
| 023 | リダイレクト管理 | 2025-12-27 |
| 024 | セキュリティヘッダー | 2025-12-27 |
| 025 | リンク検証機能 | 2025-12-27 |
| 026 | サイトマップUI | 2025-12-27 |
| 070 | 多言語対応（i18n） | 2025-12-28 |
| 071 | テスト戦略 | 2025-12-28 |
| 073 | メディア整理 | 2025-12-28 |
| 074 | エクスポート機能 | 2025-12-28 |
| 075 | OAuth連携解除・ユーザーマージ | 2025-12-28 |
| 076 | path_prefix衝突検出 | 2025-12-28 |
| 077 | カスタムルーティング | 2025-12-28 |
| 078 | プラグイン依存関係解決 | 2025-12-28 |
| 079 | プラグイン権限分離 | 2025-12-28 |
| 080 | テーマ継承・子テーマ | 2025-12-28 |
| 081 | マーケットプレイス署名検証 | 2025-12-28 |
| 082 | 設定優先順位明確化 | 2025-12-28 |
| 083 | ゼロダウンタイムデプロイ | 2025-12-28 |
| 084 | コメントスパム高度対策 | 2025-12-28 |
| 085 | 用語統一 | 2025-12-28 |
| 086 | site_setting位置づけ明確化 | 2025-12-28 |
| 087 | created_by/updated_by FK制約 | 2025-12-28 |
| 088 | 設計書更新 | 2025-12-28 |
| 089 | pip installable対応 | 2025-12-28 |
